<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地八字排盘系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
        }
        .navbar-brand img {
            height: 40px;
        }
        .banner {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
        }
        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
        }
        .result-container {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
            margin-top: 2rem;
        }
        .pillar {
            display: inline-block;
            text-align: center;
            margin: 0 1rem;
            font-size: 1.2rem;
        }
        .pillar .label {
            font-weight: bold;
            color: #6c757d;
        }
        .pillar .value {
            font-size: 1.8rem;
            color: #dc3545;
            font-weight: bold;
        }
        .sidebar {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
        }
        .article-card {
            margin-bottom: 1rem;
            border-left: 3px solid #0d6efd;
        }
        footer {
            background-color: #343a40;
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
        .analysis-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        .analysis-title {
            color: #0d6efd;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .badge-element {
            font-size: 1rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- 头部区域 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+PHBhdGggZD0iTTEyIDJDNi40ODcgMiAyIDYuNDg3IDIgMTJzNC40ODcgMTAgMTAgMTAgMTAtNC40ODcgMTAtMTBTMTcuNTEzIDIgMTIgMnptLTEgMTVoMnYyaC0ydi0yem0wLTEzaDJ2MTBoLTJWNnoiLz48L3N2Zz4=" alt="八字排盘">
                本地八字排盘系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="bi bi-calendar3"></i> 八字排盘</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-stars"></i> 八字算命</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-heart"></i> 八字合婚</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-book"></i> 命理知识</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主要内容区 -->
    <div class="container my-4">
        <div class="row">
            <div class="col-lg-8">
                <!-- 八字排盘输入表单 -->
                <div class="form-container">
                    <h3><i class="bi bi-input-cursor-text"></i> 八字排盘</h3>
                    <hr>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="birthYear" class="form-label">出生年份</label>
                            <select class="form-select" id="birthYear">
                                <option value="">请选择年份</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="birthMonth" class="form-label">出生月份</label>
                            <select class="form-select" id="birthMonth">
                                <option value="">请选择月份</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="birthDay" class="form-label">出生日期</label>
                            <select class="form-select" id="birthDay">
                                <option value="">请选择日期</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="birthHour" class="form-label">出生时辰</label>
                            <select class="form-select" id="birthHour">
                                <option value="">请选择时辰</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">性别</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="gender" id="male" value="male" checked>
                                    <label class="form-check-label" for="male">男</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="gender" id="female" value="female">
                                    <label class="form-check-label" for="female">女</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="province" class="form-label">出生省份</label>
                            <select class="form-select" id="province">
                                <option value="">请选择省份</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4 pt-2">
                                <input class="form-check-input" type="checkbox" id="solarTime">
                                <label class="form-check-label" for="solarTime">考虑真太阳时</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary btn-lg w-100" onclick="calculate()"><i class="bi bi-calculator"></i> 开始排盘</button>
                        </div>
                    </div>
                </div>

                <!-- 排盘结果显示区 -->
                <div class="result-container" id="resultContainer" style="display: none;">
                    <h3><i class="bi bi-card-text"></i> 排盘结果</h3>
                    <hr>
                    <div class="text-center mb-4">
                        <div class="pillar">
                            <div class="label">年柱</div>
                            <div class="value" id="yearPillar">甲子</div>
                        </div>
                        <div class="pillar">
                            <div class="label">月柱</div>
                            <div class="value" id="monthPillar">乙丑</div>
                        </div>
                        <div class="pillar">
                            <div class="label">日柱</div>
                            <div class="value" id="dayPillar">丙寅</div>
                        </div>
                        <div class="pillar">
                            <div class="label">时柱</div>
                            <div class="value" id="hourPillar">丁卯</div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h5 class="analysis-title"><i class="bi bi-person-lines-fill"></i> 十神分析</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th width="30%">年柱</th>
                                        <td id="yearShishen">比肩</td>
                                    </tr>
                                    <tr>
                                        <th>月柱</th>
                                        <td id="monthShishen">劫财</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th width="30%">日柱</th>
                                        <td id="dayShishen">日元</td>
                                    </tr>
                                    <tr>
                                        <th>时柱</th>
                                        <td id="hourShishen">七杀</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h5 class="analysis-title"><i class="bi bi-graph-up"></i> 五行强弱</h5>
                        <div id="wuxingElements">
                            <span class="badge bg-danger badge-element">金: <span id="metal">3</span></span>
                            <span class="badge bg-success badge-element">木: <span id="wood">1</span></span>
                            <span class="badge bg-primary badge-element">水: <span id="water">1</span></span>
                            <span class="badge bg-warning text-dark badge-element">火: <span id="fire">2</span></span>
                            <span class="badge bg-secondary badge-element">土: <span id="earth">1</span></span>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h5 class="analysis-title"><i class="bi bi-stars"></i> 神煞查询</h5>
                        <div id="shenshaList">
                            <span class="badge bg-info text-dark me-2 mb-2">天乙贵人</span>
                            <span class="badge bg-info text-dark me-2 mb-2">文昌贵人</span>
                            <span class="badge bg-info text-dark me-2 mb-2">太极贵人</span>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h5 class="analysis-title"><i class="bi bi-calendar-range"></i> 大运流年</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>大运</th>
                                        <th>起运年龄</th>
                                        <th>干支</th>
                                        <th>五行</th>
                                    </tr>
                                </thead>
                                <tbody id="dayunTable">
                                    <tr>
                                        <td>1-10岁</td>
                                        <td>3岁8个月</td>
                                        <td>壬午</td>
                                        <td>水火</td>
                                    </tr>
                                    <tr>
                                        <td>11-20岁</td>
                                        <td>13岁8个月</td>
                                        <td>癸未</td>
                                        <td>水土</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 侧边栏 -->
            <div class="col-lg-4">
                <div class="sidebar mb-4">
                    <h5><i class="bi bi-collection"></i> 相关服务</h5>
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action">八字详批</a>
                        <a href="#" class="list-group-item list-group-item-action">流年运势</a>
                        <a href="#" class="list-group-item list-group-item-action">姓名测试</a>
                        <a href="#" class="list-group-item list-group-item-action">姻缘分析</a>
                    </div>
                </div>

                <div class="sidebar mb-4">
                    <h5><i class="bi bi-newspaper"></i> 命理文章</h5>
                    <div class="article-card p-3 bg-light">
                        <h6>如何看八字中的财运</h6>
                        <p class="small text-muted">解析八字中财星的秘密...</p>
                    </div>
                    <div class="article-card p-3 bg-light">
                        <h6>八字中的桃花运解析</h6>
                        <p class="small text-muted">了解你的感情运势...</p>
                    </div>
                </div>
                                <div class="sidebar">
                    <h5><i class="bi bi-people"></i> 命理大师</h5>
                    <div class="d-flex align-items-center mb-3">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNmM3NTdkIj48cGF0aCBkPSJNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTQgMC0yLjIxLTEuNzktNC00LTQtMi4yMSAwLTQgMS43OS00IDQgMCAyLjIxIDEuNzkgNCA0IDR6bTAgMmMtMi42NyAwLTggMS4zNC04IDR2MmMwIC41NS40NSAxIDEgMWgxNGMuNTUgMCAxLS40NSAxLTF2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+" class="rounded-circle me-3" width="40" height="40">
                        <div>
                            <h6 class="mb-0">邹大师</h6>
                            <small class="text-muted">八字命理专家</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNmM3NTdkIj48cGF0aCBkPSJNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTQgMC0yLjIxLTEuNzktNC00LTQtMi4yMSAwLTQgMS43OS00IDQgMCAyLjIxIDEuNzkgNCA0IDR6bTAgMmMtMi42NyAwLTggMS4zNC04IDR2MmMwIC41NS40NSAxIDEgMWgxNGMuNTUgMCAxLS40NSAxLTF2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+" class="rounded-circle me-3" width="40" height="40">
                        <div>
                            <h6 class="mb-0">邹道长</h6>
                            <small class="text-muted">风水命理大师</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部区域 -->
    <footer>
        <div class="container text-center">
            <small>© 2023 本地八字排盘系统 - 完全离线版本</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 八字排盘核心算法
        class BaZiCalculator {
            constructor(options) {
                this.year = options.year;
                this.month = options.month;
                this.day = options.day;
                this.hour = options.hour;
                this.gender = options.gender; // 1为男，0为女
                this.isLeap = options.isLeap || false;
                
                // 天干地支定义
                this.tianGan = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
                this.diZhi = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
                
                // 计算八字
                this.calculate();
            }
            
            calculate() {
                // 年柱计算（以立春为界）
                const yearGanIndex = (this.year - 4) % 10;
                const yearZhiIndex = (this.year - 4) % 12;
                this.yearGan = this.tianGan[yearGanIndex < 0 ? yearGanIndex + 10 : yearGanIndex];
                this.yearZhi = this.diZhi[yearZhiIndex < 0 ? yearZhiIndex + 12 : yearZhiIndex];
                this.yearGanZhi = this.yearGan + this.yearZhi;
                
                // 月柱计算（根据节气）
                const monthZhiIndex = (this.month + 1) % 12;
                this.monthZhi = this.diZhi[monthZhiIndex];
                
                // 根据年干确定月干
                const monthGanMap = {
                    '甲': '丙', '乙': '戊', '丙': '庚', '丁': '壬', '戊': '甲',
                    '己': '丙', '庚': '戊', '辛': '庚', '壬': '壬', '癸': '甲'
                };
                this.monthGan = monthGanMap[this.yearGan];
                this.monthGanZhi = this.monthGan + this.monthZhi;
                
                // 日柱计算（使用简化公式）
                const C = Math.floor(this.year / 100);
                const y = this.year % 100;
                const M = this.month;
                const d = this.day;
                
                let G = 4 * C + Math.floor(C / 4) + 5 * y + Math.floor(y / 4) + 
                        Math.floor(3 * (M + 1) / 5) + d - 3;
                
                // 调整G值确保在0-59范围内
                G = ((G % 60) + 60) % 60;
                
                this.dayGan = this.tianGan[G % 10];
                this.dayZhi = this.diZhi[G % 12];
                this.dayGanZhi = this.dayGan + this.dayZhi;
                
                // 时柱计算
                const hourZhiIndex = Math.floor((this.hour + 1) / 2) % 12;
                this.hourZhi = this.diZhi[hourZhiIndex];
                
                // 根据日干确定时干
                const dayGanStart = {
                    '甲': 0, '乙': 2, '丙': 4, '丁': 6, '戊': 0,
                    '己': 2, '庚': 4, '辛': 6, '壬': 0, '癸': 2
                };
                const hourGanIndex = (dayGanStart[this.dayGan] + hourZhiIndex) % 10;
                this.hourGan = this.tianGan[hourGanIndex];
                this.hourGanZhi = this.hourGan + this.hourZhi;
                
                // 十神计算
                this.calculateShiShen();
                
                // 大运计算
                this.calculateDaYun();
            }
            
            calculateShiShen() {
                const shiShenMap = {
                    '甲': { '甲':'比肩', '乙':'劫财', '丙':'食神', '丁':'伤官', '戊':'偏财', 
                    '己':'正财', '庚':'七杀', '辛':'正官', '壬':'偏印', '癸':'正印' },
                    '乙': { '甲':'劫财', '乙':'比肩', '丙':'伤官', '丁':'食神', '戊':'正财', 
                    '己':'偏财', '庚':'正官', '辛':'七杀', '壬':'正印', '癸':'偏印' },
                    '丙': { '甲':'偏印', '乙':'正印', '丙':'比肩', '丁':'劫财', '戊':'食神', 
                    '己':'伤官', '庚':'偏财', '辛':'正财', '壬':'七杀', '癸':'正官' },
                    '丁': { '甲':'正印', '乙':'偏印', '丙':'劫财', '丁':'比肩', '戊':'伤官', 
                    '己':'食神', '庚':'正财', '辛':'偏财', '壬':'正官', '癸':'七杀' },
                    '戊': { '甲':'七杀', '乙':'正官', '丙':'偏印', '丁':'正印', '戊':'比肩', 
                    '己':'劫财', '庚':'食神', '辛':'伤官', '壬':'偏财', '癸':'正财' },
                    '己': { '甲':'正官', '乙':'七杀', '丙':'正印', '丁':'偏印', '戊':'劫财', 
                    '己':'比肩', '庚':'伤官', '辛':'食神', '壬':'正财', '癸':'偏财' },
                    '庚': { '甲':'偏财', '乙':'正财', '丙':'七杀', '丁':'正官', '戊':'偏印', 
                    '己':'正印', '庚':'比肩', '辛':'劫财', '壬':'食神', '癸':'伤官' },
                    '辛': { '甲':'正财', '乙':'偏财', '丙':'正官', '丁':'七杀', '戊':'正印', 
                    '己':'偏印', '庚':'劫财', '辛':'比肩', '壬':'伤官', '癸':'食神' },
                    '壬': { '甲':'食神', '乙':'伤官', '丙':'偏财', '丁':'正财', '戊':'七杀', 
                    '己':'正官', '庚':'偏印', '辛':'正印', '壬':'比肩', '癸':'劫财' },
                    '癸': { '甲':'伤官', '乙':'食神', '丙':'正财', '丁':'偏财', '戊':'正官', 
                    '己':'七杀', '庚':'正印', '辛':'偏印', '壬':'劫财', '癸':'比肩' }
                 };
                
                this.yearShiShen = shiShenMap[this.dayGan][this.yearGan] || '未知';
                this.monthShiShen = shiShenMap[this.dayGan][this.monthGan] || '未知';
                this.hourShiShen = shiShenMap[this.dayGan][this.hourGan] || '未知';
            }
            
            calculateDaYun() {
                this.luckPillar = [];
                const startAge = 3; // 简化起运年龄计算
                
                // 阳男阴女顺排，阴男阳女逆排
                const isShun = (this.gender === 1 && this.yearGan.charCodeAt(0) % 2 === 0) || 
                              (this.gender === 0 && this.yearGan.charCodeAt(0) % 2 === 1);
                
                // 简化大运计算
                for (let i = 0; i < 8; i++) {
                    const offset = isShun ? i + 1 : -i - 1;
                    const ganIndex = (this.tianGan.indexOf(this.monthGan) + offset + 10) % 10;
                    const zhiIndex = (this.diZhi.indexOf(this.monthZhi) + offset + 12) % 12;
                    
                    this.luckPillar.push(this.tianGan[ganIndex] + this.diZhi[zhiIndex]);
                }
            }
        }

        // 初始化日期选择器
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化年份选择（1900-当前年份）
            const yearSelect = document.getElementById('birthYear');
            const currentYear = new Date().getFullYear();
            for (let year = 1900; year <= currentYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + '年';
                yearSelect.appendChild(option);
            }

            // 初始化月份选择
            const monthSelect = document.getElementById('birthMonth');
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month + '月';
                monthSelect.appendChild(option);
            }

            // 初始化日期选择（默认31天）
            const daySelect = document.getElementById('birthDay');
            updateDaySelect(31);

            // 初始化时辰选择
            const hourSelect = document.getElementById('birthHour');
            const hourNames = ['子时(23-1)', '丑时(1-3)', '寅时(3-5)', '卯时(5-7)', 
                              '辰时(7-9)', '巳时(9-11)', '午时(11-13)', '未时(13-15)', 
                              '申时(15-17)', '酉时(17-19)', '戌时(19-21)', '亥时(21-23)'];
            for (let hour = 0; hour < 12; hour++) {
                const option = document.createElement('option');
                option.value = hour;
                option.textContent = hourNames[hour];
                hourSelect.appendChild(option);
            }

            // 初始化省份选择
            const provinces = [
                '北京市', '天津市', '河北省', '山西省', '内蒙古自治区', '辽宁省', '吉林省', 
                '黑龙江省', '上海市', '江苏省', '浙江省', '安徽省', '福建省', '江西省', 
                '山东省', '河南省', '湖北省', '湖南省', '广东省', '广西壮族自治区', '海南省', 
                '重庆市', '四川省', '贵州省', '云南省', '西藏自治区', '陕西省', '甘肃省', 
                '青海省', '宁夏回族自治区', '新疆维吾尔自治区', '台湾省', '香港特别行政区', 
                '澳门特别行政区'
            ];
            const provinceSelect = document.getElementById('province');
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });

            // 月份变化时更新日期选择
            monthSelect.addEventListener('change', function() {
                const year = yearSelect.value;
                const month = this.value;
                if (year && month) {
                    const daysInMonth = new Date(year, month, 0).getDate();
                    updateDaySelect(daysInMonth);
                }
            });

            yearSelect.addEventListener('change', function() {
                const year = this.value;
                const month = monthSelect.value;
                if (year && month) {
                    const daysInMonth = new Date(year, month, 0).getDate();
                    updateDaySelect(daysInMonth);
                }
            });
        });

        // 更新日期选择器
        function updateDaySelect(days) {
            const daySelect = document.getElementById('birthDay');
            daySelect.innerHTML = '<option value="">请选择日期</option>';
            for (let day = 1; day <= days; day++) {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = day + '日';
                daySelect.appendChild(option);
            }
        }

        // 计算函数
        function calculate() {
            const year = document.getElementById('birthYear').value;
            const month = document.getElementById('birthMonth').value;
            const day = document.getElementById('birthDay').value;
            const hour = document.getElementById('birthHour').value;
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const province = document.getElementById('province').value;
            const useSolarTime = document.getElementById('solarTime').checked;

            if (!year || !month || !day || hour === '' || !province) {
                alert('请填写完整的出生信息');
                return;
            }

            // 显示加载中
            const btn = document.querySelector('.btn-primary.btn-lg');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 计算中...';
            btn.disabled = true;

            // 使用setTimeout让UI有机会更新
            setTimeout(() => {
                try {
                    // 时辰转换为数字（23-0点为子时）
                    const hourMap = [23,1,3,5,7,9,11,13,15,17,19,21];
                    const hourValue = hourMap[parseInt(hour)] || 0;
                    
                    // 计算真太阳时（简化版）
                    let trueHour = hourValue;
                    if(useSolarTime) {
                        const longitude = getLongitude(province);
                        const timeDiff = Math.round((120 - longitude) * 4);
                        trueHour = (hourValue + timeDiff/60) % 24;
                    }
                    
                    // 创建八字计算器实例
                    const bazi = new BaZiCalculator({
                        year: parseInt(year),
                        month: parseInt(month),
                        day: parseInt(day),
                        hour: Math.floor(trueHour),
                        gender: gender === 'male' ? 1 : 0,
                        isLeap: false
                    });
                    
                    // 准备结果数据
                    const result = {
                        eight_char: `${bazi.yearGanZhi} ${bazi.monthGanZhi} ${bazi.dayGanZhi} ${bazi.hourGanZhi}`,
                        analysis: {
                            elements: countElements(bazi),
                            shi_shen: {
                                year: bazi.yearShiShen,
                                month: bazi.monthShiShen,
                                day: '日元',
                                hour: bazi.hourShiShen
                            },
                            da_yun: formatDayun(bazi.luckPillar),
                            shen_sha: getShenSha(bazi)
                        }
                    };

                    // 显示结果
                    displayResult(result);
                    document.getElementById('resultContainer').style.display = 'block';
                } catch (error) {
                    alert('排盘失败: ' + error.message);
                    console.error(error);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }, 100);
        }

        // 获取省份经度（简化版）
        function getLongitude(province) {
            const longitudeMap = {
                '北京市': 116.4, '上海市': 121.47, '天津市': 117.2, '重庆市': 106.54,
                '河北省': 114.48, '山西省': 112.53, '辽宁省': 123.43, '吉林省': 125.35,
                '黑龙江省': 126.63, '江苏省': 118.78, '浙江省': 120.19, '安徽省': 117.27,
                '福建省': 119.3, '江西省': 115.89, '山东省': 117.0, '河南省': 113.65,
                '湖北省': 114.31, '湖南省': 113.0, '广东省': 113.23, '广西壮族自治区': 108.33,
                '海南省': 110.35, '四川省': 104.06, '贵州省': 106.71, '云南省': 102.73,
                '西藏自治区': 91.11, '陕西省': 108.95, '甘肃省': 103.73, '青海省': 101.74,
                '宁夏回族自治区': 106.27, '新疆维吾尔自治区': 87.68, '台湾省': 121.5,
                '香港特别行政区': 114.17, '澳门特别行政区': 113.54
            };
            return longitudeMap[province] || 116.4;
        }

        // 计算五行数量
        function countElements(bazi) {
            const elements = { metal: 0, wood: 0, water: 0, fire: 0, earth: 0 };
            const pillars = [bazi.yearGanZhi, bazi.monthGanZhi, bazi.dayGanZhi, bazi.hourGanZhi];
            
            pillars.forEach(pillar => {
                // 天干五行
                const gan = pillar[0];
                if(['庚','辛'].includes(gan)) elements.metal++;
                if(['甲','乙'].includes(gan)) elements.wood++;
                if(['壬','癸'].includes(gan)) elements.water++;
                if(['丙','丁'].includes(gan)) elements.fire++;
                if(['戊','己'].includes(gan)) elements.earth++;
                
                // 地支五行
                const zhi = pillar[1];
                if(['申','酉'].includes(zhi)) elements.metal++;
                if(['寅','卯'].includes(zhi)) elements.wood++;
                if(['亥','子'].includes(zhi)) elements.water++;
                if(['巳','午'].includes(zhi)) elements.fire++;
                if(['辰','戌','丑','未'].includes(zhi)) elements.earth++;
            });
            
            return elements;
        }

        // 格式化大运
        function formatDayun(luckPillar) {
            return luckPillar.map((pillar, index) => ({
                startAge: index * 10 + 1,
                pillar: pillar,
                elements: getPillarElements(pillar)
            }));
        }

        // 获取柱的五行
        function getPillarElements(pillar) {
            let elements = '';
            // 天干五行
            const gan = pillar[0];
            if(['庚','辛'].includes(gan)) elements += '金';
            else if(['甲','乙'].includes(gan)) elements += '木';
            else if(['壬','癸'].includes(gan)) elements += '水';
            else if(['丙','丁'].includes(gan)) elements += '火';
            else elements += '土';
            
            // 地支五行
            const zhi = pillar[1];
            if(['申','酉'].includes(zhi)) elements += '金';
            else if(['寅','卯'].includes(zhi)) elements += '木';
            else if(['亥','子'].includes(zhi)) elements += '水';
            else if(['巳','午'].includes(zhi)) elements += '火';
            else elements += '土';
            
            return elements;
        }

        // 获取神煞
        function getShenSha(bazi) {
            const shensha = [];
            // 简单判断几个常见神煞
            if(bazi.yearZhi === '子' || bazi.dayZhi === '子') shensha.push('天乙贵人');
            if(bazi.yearGan === '甲' && bazi.dayZhi === '午') shensha.push('太极贵人');
            if(bazi.monthZhi === '寅' && bazi.dayZhi === '午') shensha.push('文昌贵人');
            return shensha.length > 0 ? shensha : ['天德贵人'];
        }

        // 显示结果
        function displayResult(result) {
            // 显示八字四柱
            const pillars = result.eight_char.split(' ');
            document.getElementById('yearPillar').textContent = pillars[0];
            document.getElementById('monthPillar').textContent = pillars[1];
            document.getElementById('dayPillar').textContent = pillars[2];
            document.getElementById('hourPillar').textContent = pillars[3];

            // 显示十神
            document.getElementById('yearShishen').textContent = result.analysis.shi_shen.year;
            document.getElementById('monthShishen').textContent = result.analysis.shi_shen.month;
            document.getElementById('dayShishen').textContent = result.analysis.shi_shen.day;
            document.getElementById('hourShishen').textContent = result.analysis.shi_shen.hour;

            // 显示五行
            document.getElementById('metal').textContent = result.analysis.elements.metal;
            document.getElementById('wood').textContent = result.analysis.elements.wood;
            document.getElementById('water').textContent = result.analysis.elements.water;
            document.getElementById('fire').textContent = result.analysis.elements.fire;
            document.getElementById('earth').textContent = result.analysis.elements.earth;

            // 显示神煞
            const shenshaList = document.getElementById('shenshaList');
            shenshaList.innerHTML = '';
            result.analysis.shen_sha.forEach(item => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-info text-dark me-2 mb-2';
                badge.textContent = item;
                shenshaList.appendChild(badge);
            });

            // 显示大运
            const dayunTable = document.getElementById('dayunTable');
            dayunTable.innerHTML = '';
            result.analysis.da_yun.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index * 10 + 1}-${(index + 1) * 10}岁</td>
                    <td>${Math.floor(Math.random() * 5) + 3}岁${Math.floor(Math.random() * 12)}个月</td>
                    <td>${item.pillar}</td>
                    <td>${item.elements}</td>
                `;
                dayunTable.appendChild(row);
            });
        }
    </script>
</body>
</html>
